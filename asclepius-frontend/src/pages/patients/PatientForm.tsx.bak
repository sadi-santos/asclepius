import { FormEvent, useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { api } from "../../lib/api";
import type { Patient } from "../../types";

const empty: Partial<Patient> = {
  fullName: "",
  cpf: "",
  birthDate: "1988-03-15T00:00:00Z",
  email: "",
  phone: "",
  address: "",
  bloodType: "O+",
  allergies: "",
  notes: "",
  isActive: true,
};

export default function PatientForm(){
  const { id } = useParams();
  const nav = useNavigate();
  const [model, setModel] = useState<Partial<Patient>>(empty);
  const isEdit = Boolean(id);

  useEffect(() => { if (id) api.get<Patient>(`/patients/${id}`).then(r => setModel(r.data)); }, [id]);

  async function onSubmit(e: FormEvent){
    e.preventDefault();
    const payload = {
      fullName: model.fullName || "",
      cpf: model.cpf || "",
      birthDate: model.birthDate || "1988-03-15T00:00:00Z",
      email: model.email || "",
      phone: model.phone || "",
      address: model.address || "",
      bloodType: model.bloodType || "O+",
      allergies: model.alergies || model.allergies || "",
      notes: model.notes || "",
      isActive: model.isActive ?? true,
    };
    if (isEdit) await api.put(`/patients/${id}`, payload);
    else await api.post("/patients", payload);
    nav("/patients");
  }

  return (
    <form onSubmit={onSubmit} className="space-y-3 max-w-lg">
      <h2 className="text-xl font-semibold">{isEdit ? "Editar" : "Novo"} Paciente</h2>
      <input className="w-full border p-2" placeholder="Nome" value={model.fullName||""} onChange={e=>setModel({...model, fullName:e.target.value})} />
      <input className="w-full border p-2" placeholder="CPF" value={model.cpf||""} onChange={e=>setModel({...model, cpf:e.target.value})} />
      <input className="w-full border p-2" placeholder="Email" value={model.email||""} onChange={e=>setModel({...model, email:e.target.value})} />
      <input className="w-full border p-2" placeholder="Telefone" value={model.phone||""} onChange={e=>setModel({...model, phone:e.target.value})} />
      <input className="w-full border p-2" placeholder="Endereço" value={model.address||""} onChange={e=>setModel({...model, address:e.target.value})} />
      <div className="grid grid-cols-2 gap-3">
        <input className="border p-2" placeholder="Tipo Sanguíneo" value={model.bloodType||""} onChange={e=>setModel({...model, bloodType:e.target.value})} />
        <input className="border p-2" placeholder="Data de Nascimento (ISO)" value={model.birthDate||""} onChange={e=>setModel({...model, birthDate:e.target.value})} />
      </div>
      <input className="w-full border p-2" placeholder="Alergias" value={model.allergies||""} onChange={e=>setModel({...model, allergies:e.target.value})} />
      <textarea className="w-full border p-2" placeholder="Notas" value={model.notes||""} onChange={e=>setModel({...model, notes:e.target.value})} />
      <div className="flex items-center gap-2">
        <input id="active" type="checkbox" checked={model.isActive ?? true} onChange={e=>setModel({...model, isActive:e.target.checked})} />
        <label htmlFor="active">Ativo</label>
      </div>
      <div className="flex gap-2">
        <button className="bg-blue-600 text-white px-3 py-2 rounded" type="submit">Salvar</button>
        <button className="px-3 py-2 border rounded" type="button" onClick={()=>nav("/patients")}>Cancelar</button>
      </div>
    </form>
  );
}
