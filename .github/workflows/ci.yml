name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: asclepius_test
        options: >-
          --health-cmd="pg_isready -U postgres -d asclepius_test"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      CI: true
      NODE_ENV: test
      # Ajuste se quiser padronizar com seu local; estes valores combinam com o service acima
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/asclepius_test?schema=public

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
          submodules: false

      - name: Setup Node 20 (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      # ✅ Resolve "Unable to locate executable file: pnpm"
      - name: Install PNPM 10.18.2 globally
        run: |
          npm i -g pnpm@10.18.2
          pnpm -v
          node -v

      # Opcional: cliente psql para diagnósticos/wait
      - name: Install PostgreSQL client (pg_isready, psql)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Prepare logs dir
        run: |
          mkdir -p logs
          echo "Logs do CI" > logs/_placeholder.txt

      - name: Show workspace tree (diag)
        run: |
          ls -la
          ls -la asclepius-backend || true
          ls -la asclepius-frontend || true

      - name: Install deps (workspace)
        run: |
          pnpm install -r --frozen-lockfile 2>&1 | tee -a logs/install.txt

      - name: List scripts (diag)
        run: |
          echo "== BACKEND scripts ==" | tee -a logs/scripts.txt
          pnpm -C asclepius-backend pkg get scripts | tee -a logs/scripts.txt || true
          echo "== FRONTEND scripts ==" | tee -a logs/scripts.txt
          pnpm -C asclepius-frontend pkg get scripts | tee -a logs/scripts.txt || true

      - name: Wait for Postgres (pg_isready)
        run: |
          for i in {1..60}; do
            pg_isready -h localhost -p 5432 -U postgres -d asclepius_test && echo "Postgres OK" && exit 0
            echo "Aguardando Postgres... ($i)"; sleep 1;
          done
          echo "Postgres não respondeu a tempo" >&2
          exit 1

      # --- Prisma (backend) ---
      - name: Prisma generate (backend)
        run: |
          pnpm --filter "./asclepius-backend" exec prisma generate 2>&1 | tee -a logs/prisma.txt

      - name: Prisma migrate deploy (backend)
        run: |
          pnpm --filter "./asclepius-backend" exec prisma migrate deploy 2>&1 | tee -a logs/prisma.txt

      # após:
      # - name: Prisma migrate deploy (backend)
      #   run: pnpm --filter "./asclepius-backend" exec prisma migrate deploy

      - name: Seed (se existir)
        shell: bash
        run: |
          # roda seed se o script existir no package.json
          pnpm --filter "./asclepius-backend" run --if-present prisma:seed 2>&1 | tee -a logs/seed.txt || true

      - name: Ensure admin (se existir)
        shell: bash
        env:
          ADMIN_EMAIL: ${{ secrets.CI_LOGIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.CI_LOGIN_PASSWORD }}
        run: |
          set -e
          if [ -z "$ADMIN_EMAIL" ] || [ -z "$ADMIN_PASSWORD" ]; then
            echo "Sem ADMIN_EMAIL/ADMIN_PASSWORD nos secrets — pulando ensure-admin." | tee -a logs/ensure-admin.txt
            exit 0
          fi

          if [ -f asclepius-backend/dist/scripts/ensure-admin.js ]; then
            echo "Executando ensure-admin compilado" | tee -a logs/ensure-admin.txt
            node asclepius-backend/dist/scripts/ensure-admin.js "$ADMIN_EMAIL" "$ADMIN_PASSWORD" 2>&1 | tee -a logs/ensure-admin.txt || true
          else
            echo "Executando ensure-admin via ts-node" | tee -a logs/ensure-admin.txt
            pnpm --filter "./asclepius-backend" exec ts-node src/scripts/ensure-admin.ts "$ADMIN_EMAIL" "$ADMIN_PASSWORD" 2>&1 | tee -a logs/ensure-admin.txt || true
          fi

      # --- Build/Test backend (obrigatórios) ---
      - name: Build (backend)
        run: |
          pnpm --filter "./asclepius-backend" run build 2>&1 | tee -a logs/build-backend.txt

      - name: Test (backend)
        run: |
          pnpm --filter "./asclepius-backend" run test 2>&1 | tee -a logs/test-backend.txt

      # --- Frontend (opcionais: só se houver script) ---
      - name: Test (frontend, if-present)
        run: |
          pnpm --filter "./asclepius-frontend" run --if-present test 2>&1 | tee -a logs/test-frontend.txt
        continue-on-error: true

      - name: Build (frontend, if-present)
        run: |
          pnpm --filter "./asclepius-frontend" run --if-present build 2>&1 | tee -a logs/build-frontend.txt
        continue-on-error: true

      # Artifacts sempre (evita "No files were found...")
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: logs/**
          retention-days: 7
