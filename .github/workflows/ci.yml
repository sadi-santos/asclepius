name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: asclepius_test
        options: >-
          --health-cmd="pg_isready -U postgres -d asclepius_test"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      CI: true
      NODE_ENV: test
      PNPM_LOG_LEVEL: debug
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/asclepius_test?schema=public

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
          submodules: false

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install PNPM 10.18.2 globally
        run: |
          npm i -g pnpm@10.18.2
          pnpm -v
          node -v

      - name: Install deps (workspace) — verbose
        run: |
          mkdir -p logs
          set -o pipefail
          pnpm install -r --frozen-lockfile 2>&1 | tee logs/pnpm_install.log

      - name: List scripts (diagnostic)
        run: |
          echo "== BACKEND scripts ==" | tee -a logs/diagnostic.txt
          pnpm -C asclepius-backend pkg get scripts 2>&1 | tee -a logs/diagnostic.txt || true
          echo "== FRONTEND scripts ==" | tee -a logs/diagnostic.txt
          pnpm -C asclepius-frontend pkg get scripts 2>&1 | tee -a logs/diagnostic.txt || true

      - name: Wait for Postgres (TCP)
        shell: bash
        run: |
          set -e
          for i in {1..60}; do
            (echo > /dev/tcp/localhost/5432) >/dev/null 2>&1 && { echo "Postgres OK"; exit 0; }
            echo "Aguardando Postgres... ($i)"; sleep 1;
          done
          echo "Postgres não respondeu a tempo"; exit 1

      # --- Prisma (backend) ---
      - name: Prisma generate (backend)
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-backend" exec prisma generate 2>&1 | tee logs/prisma_generate.log

      - name: Prisma migrate status (backend)
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-backend" exec prisma migrate status 2>&1 | tee logs/prisma_migrate_status.log

      - name: Prisma migrate deploy (backend)
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-backend" exec prisma migrate deploy 2>&1 | tee logs/prisma_migrate_deploy.log

      # após:
      # - name: Prisma migrate deploy (backend)
      #   run: pnpm --filter "./asclepius-backend" exec prisma migrate deploy

      - name: Seed (se existir)
        shell: bash
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-backend" run --if-present prisma:seed 2>&1 | tee logs/prisma_seed.log

      - name: Ensure admin (se existir)
        shell: bash
        env:
          ADMIN_EMAIL: ${{ secrets.CI_LOGIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.CI_LOGIN_PASSWORD }}
        run: |
          if [ -z "$ADMIN_EMAIL" ] || [ -z "$ADMIN_PASSWORD" ]; then
            echo "Sem ADMIN_EMAIL/ADMIN_PASSWORD nos secrets — pulando ensure-admin."
            exit 0
          fi
          set -o pipefail
          if [ -f asclepius-backend/dist/scripts/ensure-admin.js ]; then
            echo "Executando ensure-admin (dist)..."
            node asclepius-backend/dist/scripts/ensure-admin.js "$ADMIN_EMAIL" "$ADMIN_PASSWORD" 2>&1 | tee logs/ensure_admin.log
          else
            echo "Executando ensure-admin (ts-node)..."
            pnpm --filter "./asclepius-backend" exec ts-node src/scripts/ensure-admin.ts "$ADMIN_EMAIL" "$ADMIN_PASSWORD" 2>&1 | tee logs/ensure_admin.log
          fi

      # --- Build/Test backend (obrigatórios) ---
      - name: Build (backend) — verbose
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-backend" run build 2>&1 | tee logs/backend_build.log

      - name: Test (backend) — verbose
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-backend" run test 2>&1 | tee logs/backend_test.log

      # --- Frontend (opcionais) ---
      - name: Test (frontend, if-present)
        continue-on-error: true
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-frontend" run --if-present test 2>&1 | tee logs/frontend_test.log

      - name: Build (frontend, if-present)
        continue-on-error: true
        run: |
          set -o pipefail
          pnpm --filter "./asclepius-frontend" run --if-present build 2>&1 | tee logs/frontend_build.log

      # --- Smoke runtime do backend (+ body do /auth/login) ---
      - name: Start backend (bg) & wait
        run: |
          set -e
          node asclepius-backend/dist/server.js > logs/backend_runtime.log 2>&1 &
          for i in {1..60}; do
            if curl -fsS http://localhost:3001/health >/dev/null; then
              echo "Backend up"; exit 0
            fi
            echo "Aguardando backend... ($i)"
            sleep 1
          done
          echo "Backend não subiu a tempo"; exit 1

      - name: Smoke test /auth/login (não bloqueante)
        continue-on-error: true
        env:
          EMAIL: ${{ secrets.CI_LOGIN_EMAIL }}
          PASSWORD: ${{ secrets.CI_LOGIN_PASSWORD }}
        run: |
          set +e
          if [ -z "$EMAIL" ] || [ -z "$PASSWORD" ]; then
            echo "Sem CI_LOGIN_EMAIL/CI_LOGIN_PASSWORD — pulando smoke de login."
            exit 0
          fi
          RES=$(curl -sS -w "\n%{http_code}" -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}" \
            http://localhost:3001/auth/login)
          BODY=$(echo "$RES" | head -n -1)
          CODE=$(echo "$RES" | tail -n1)
          echo "HTTP $CODE"
          echo "Body:"
          echo "$BODY"
          mkdir -p logs
          echo "$BODY" > logs/auth_login_body.json

      # --- Artefatos de log ---
      - name: Upload logs (sempre)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: logs/

